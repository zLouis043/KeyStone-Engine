name: KeyStone CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- WINDOWS CONFIG ---
          - os: windows-latest
            platform: windows
            setup_cmd: cd Scripts/Windows && .\Setup.bat
            premake_action: vs2022
            build_cmd: msbuild KeyStone-Engine.sln /p:Configuration=Debug /p:Platform=x64 /m
            test_bin: KeyStoneEngine\build\bin\Debug\KeyStoneTests.exe

          # --- LINUX CONFIG ---
          - os: ubuntu-latest
            platform: linux
            setup_cmd: cd Scripts/Linux && chmod +x Setup.sh && ./Setup.sh
            premake_action: gmake2
            build_cmd: make config=debug_x64 -j$(nproc)
            test_bin: ./KeyStoneEngine/build/bin/Debug/KeyStoneTests

          # --- MACOS CONFIG ---
          - os: macos-latest
            platform: macos
            setup_cmd: cd Scripts/Macos && chmod +x Setup.sh && ./Setup.sh
            premake_action: gmake2
            build_cmd: make config=debug -j$(sysctl -n hw.ncpu)
            test_bin: ./KeyStoneEngine/build/bin/Debug/KeyStoneTests

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Premake (Windows)
      if: matrix.platform == 'windows'
      run: |
        Invoke-WebRequest -Uri "https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-windows.zip" -OutFile "premake.zip"
        Expand-Archive -Path "premake.zip" -DestinationPath "premake_bin"
        echo "$PWD/premake_bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install Premake (Linux)
      if: matrix.platform == 'linux'
      run: |
        wget https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-linux.tar.gz
        tar -xvf premake-5.0.0-beta2-linux.tar.gz
        echo "$PWD" >> $GITHUB_PATH

    - name: Install Premake (macOS)
      if: matrix.platform == 'macos'
      run: brew install premake

    - name: Setup MSVC (Windows)
      if: matrix.platform == 'windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install Linux Dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libreadline-dev

    - name: Cache Vcpkg
      uses: actions/cache@v3
      with:
        path: vendor/vcpkg/installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('Scripts/Windows/Setup.bat', 'Scripts/Linux/Setup.sh', 'Scripts/MacOS/Setup.sh') }}

    - name: Install Dependencies
      run: ${{ matrix.setup_cmd }}

    - name: Generate Build Files
      working-directory: ./KeyStoneEngine
      run: premake5 ${{ matrix.premake_action }}

    - name: Build Project
      working-directory: ./KeyStoneEngine
      run: ${{ matrix.build_cmd }}
      
    - name: Execute Tests
      run: ${{ matrix.test_bin }}